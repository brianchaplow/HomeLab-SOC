# Fluent Bit Configuration - GCP VM
# Location: /etc/fluent-bit/fluent-bit.conf
# Purpose: Ship Apache logs to OpenSearch via Tailscale
# Note: Runs as systemd service

[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

# INPUT: brianchaplow.com Apache logs
[INPUT]
    Name             tail
    Path             /var/log/apache2/brianchaplow-https-access.log
    Tag              apache.brianchaplow
    Parser           apache_stalker
    Read_from_Head   False

# INPUT: bytesbourbonbbq.com Apache logs
[INPUT]
    Name             tail
    Path             /var/log/apache2/bytesbourbonbbq-https-access.log
    Tag              apache.bytesbourbonbbq
    Parser           apache_stalker
    Read_from_Head   False

# FILTER: Add site identifier for brianchaplow.com
[FILTER]
    Name          record_modifier
    Match         apache.brianchaplow
    Record        site brianchaplow.com

# FILTER: Add site identifier for bytesbourbonbbq.com
[FILTER]
    Name          record_modifier
    Match         apache.bytesbourbonbbq
    Record        site bytesbourbonbbq.com

# OUTPUT: OpenSearch via Tailscale
# Host is Tailscale IP of QNAP NAS
[OUTPUT]
    Name             opensearch
    Match            apache.*
    Host             100.110.112.98
    Port             9200
    HTTP_User        admin
    HTTP_Passwd      ${OPENSEARCH_PASSWORD}
    Index            apache-parsed-v2
    tls              On
    tls.verify       Off
    Suppress_Type_Name On
